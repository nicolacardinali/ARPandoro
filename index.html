<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
  <title>Demo AR Vetrina â€“ Babbo Natale 3D</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.min.js"></script>
  <style>
    :root { --bg: rgba(0,0,0,.7); --fg:#fff; }
    html,body{ height:100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:#000;
           touch-action: none; }
    .hud { position: fixed; inset: 0 auto auto 0; z-index: 3; padding: 12px; color: #fff;
           background: rgba(0,0,0,.35); backdrop-filter: blur(6px); border-bottom-right-radius: 12px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#111;
             border:1px solid #333; font-size: 12px; margin-right:8px; }
    .footer { position: fixed; bottom: 0; right: 0; padding: 6px 10px; color:#fff; opacity: .7; font-size: 12px; z-index:3; }
    .overlay { position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
               flex-direction:column; color:var(--fg); background:var(--bg); z-index: 10; }
    .bar { width: min(320px, 80vw); height: 10px; border:1px solid #777; border-radius: 999px; overflow:hidden; margin-top:10px; }
    .fill{ height:100%; width:0%; background:#7dd3fc; }
    .hint { position: fixed; right: 8px; top: 8px; z-index: 3; background: rgba(0,0,0,.35); color:#fff;
            border:1px solid #333; border-radius: 10px; padding: 8px 10px; font-size: 12px; }
    .hint b{ display:block; font-size:13px; margin-bottom:4px; }
  </style>
</head>
<body>
  <div class="hud">
    <span class="badge">AR Demo</span>
    <span class="badge">Marker "Hiro"</span>
    <span class="badge">Tocca Babbo Natale ðŸ””</span>
  </div>
  <div class="hint">
    <b>Consigli</b>
    Avvicinati al marker, evita riflessi forti. Audio dopo il primo tocco.
  </div>
  <div class="footer">Â© Demo per Nicola â€“ 2025</div>

  <!-- Overlay caricamento -->
  <div id="loader" class="overlay" role="status" aria-live="polite">
    <div>Caricamentoâ€¦ <span id="pct">0%</span></div>
    <div class="bar"><div id="fill" class="fill"></div></div>
    <div style="font-size:12px;opacity:.8;margin-top:6px;">Attendi lâ€™attivazione della fotocameraâ€¦</div>
  </div>

  <a-scene
      embedded
      arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: false;"
      renderer="colorManagement: true; antialias: true">
    <a-assets id="assets" timeout="25000">
      <a-asset-item id="santa" src="assets/santa_lowpoly.glb"></a-asset-item>
      <audio id="bells" src="assets/bells.wav" preload="auto" crossorigin="anonymous"></audio>
    </a-assets>

    <a-entity camera></a-entity>

    <a-marker preset="hiro">
      <a-cylinder position="0 0 0" radius="0.75" height="0.05" color="#333"></a-cylinder>

      <!-- Babbo Natale: scala ridotta e bloccata -->
      <a-entity id="babbo"
                gltf-model="#santa"
                position="0 0.65 0"
                rotation="0 0 0"
                scale="0.06 0.06 0.06"
                animation="property: rotation; to: 0 360 0; dur: 18000; loop: true; easing: linear"
                sound="src: #bells; on: click; volume: 1.0">
      </a-entity>

      <!-- Neve e stelline: le accendiamo dopo il load per non pesare allâ€™avvio -->
      <a-entity id="snow" position="0 1.8 0" visible="false"></a-entity>
      <a-entity id="stars" position="0 1.2 0" visible="false"></a-entity>

      <a-entity position="0 0.15 0" rotation="-90 0 0">
        <a-text value="Christmas AR" color="#fff" align="center" width="6"></a-text>
      </a-entity>

      <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>
    </a-marker>

    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity id="cursor" cursor="rayOrigin: mouse"></a-entity>
    <a-entity raycaster="objects: #babbo"></a-entity>
  </a-scene>

  <script>
    // --- Previeni zoom/doppio tap ---
    document.addEventListener('dblclick', (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
    document.addEventListener('gesturestart', (e)=>{ e.preventDefault(); }, {passive:false});

    const loader = document.getElementById('loader');
    const pct = document.getElementById('pct');
    const fill = document.getElementById('fill');

    // Aggiorna barra durante il download assets
    const assets = document.getElementById('assets');
    assets.addEventListener('progress', (e) => {
      // e.detail.loadedBytes e e.detail.totalBytes non sempre sono disponibili in A-Frame; usiamo item/total
      const itemsLoaded = e.detail.loadedItems || 0;
      const itemsTotal = e.detail.totalItems || 1;
      const p = Math.round((itemsLoaded / itemsTotal) * 100);
      pct.textContent = p + '%';
      fill.style.width = p + '%';
    });

    // Quando il modello Ã¨ pronto
    const babbo = document.getElementById('babbo');
    let modelReady = false, cameraReady = false;

    const maybeHideLoader = () => {
      if (modelReady && cameraReady) {
        loader.style.display = 'none';
        // Accendi particelle SOLO ora per risparmiare CPU allâ€™avvio
        const snow = document.getElementById('snow');
        const stars = document.getElementById('stars');
        snow.setAttribute('particle-system', 'preset: snow; particleCount: 200');
        stars.setAttribute('particle-system',
          'color: #fff,#fff8e1,#ffe082; particleCount: 90; size: 0.08; maxAge: 2; velocityValue: 0 0.7 0; accelerationValue: 0 -0.4 0; opacity: 0.9');
        snow.setAttribute('visible', 'true');
        stars.setAttribute('visible', 'true');
      }
    };

    babbo.addEventListener('model-loaded', () => { modelReady = true; maybeHideLoader(); });
    babbo.addEventListener('model-error', () => { loader.innerHTML = 'Errore nel caricamento del modello.'; });

    // AR.js: attendi attivazione camera (video pronto)
    // Quando la camera Ã¨ pronta, la scena emette 'camera-set-active'
    const sceneEl = document.querySelector('a-scene');
    sceneEl.addEventListener('camera-set-active', () => { cameraReady = true; maybeHideLoader(); });

    // Blocca modifiche di scala da input multipli: accettiamo solo click singolo per suono
    const stopScaleChange = (e) => { e.preventDefault(); e.stopPropagation(); };
    babbo.addEventListener('dblclick', stopScaleChange);
    babbo.addEventListener('touchstart', (e) => {
      if (e.touches && e.touches.length > 1) { stopScaleChange(e); }
    }, {passive:false});

    // Al click riproduci solo il suono (niente animazioni di scala)
    babbo.addEventListener('click', () => {
      // Il componente <a-sound> giÃ  riproduce on:click
      // Se vuoi forzare: babbo.components.sound.playSound();
    });
  </script>
</body>
</html>
